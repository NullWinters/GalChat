<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GalChat - AI 聊天助手</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container { height: calc(100vh - 240px); }
        .sidebar { width: 260px; border-right: 1px solid #e5e7eb; }
        .message-bubble { max-width: 80%; }
        .user-message { background-color: #3b82f6; color: white; border-radius: 18px 18px 2px 18px; }
        .other-message { background-color: #f3f4f6; color: #1f2937; border-radius: 18px 18px 18px 2px; }
        .option-btn { transition: all 0.2s; }
        .option-btn:hover { transform: translateY(-2px); }
        .room-item { cursor: pointer; transition: background-color 0.2s; }
        .room-item.active { background-color: #eff6ff; border-left: 4px solid #3b82f6; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-50 flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="sidebar bg-white flex flex-col h-full shrink-0">
        <div class="p-4 border-b flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-gray-800">GalChat</h1>
                <p class="text-xs text-gray-500">AI 辅助聊天室</p>
            </div>
            <button id="shareBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors" title="分享">
                <img src="/res/share.ico" class="w-5 h-5" alt="share">
            </button>
        </div>
        <div class="p-4 flex flex-col gap-2">
            <button id="newRoomBtn" class="w-full bg-blue-500 text-white py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">新建群聊</button>
            <button id="joinRoomBtn" class="w-full border border-blue-500 text-blue-500 py-2 rounded-lg text-sm font-medium hover:bg-blue-50 transition-colors">加入群聊</button>
        </div>
        <div id="roomList" class="flex-1 overflow-y-auto">
            <!-- 群聊列表 -->
        </div>
        <div class="p-4 border-t flex items-center gap-2">
            <div id="statusDot" class="w-3 h-3 rounded-full bg-red-500" title="未连接"></div>
            <span class="text-xs text-gray-500" id="statusText">未连接</span>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full bg-gray-50 relative">
        <!-- Header -->
        <header id="chatHeader" class="bg-white shadow-sm p-4 h-16 flex items-center justify-between shrink-0">
            <h2 id="currentRoomName" class="text-lg font-bold text-gray-800">请选择或加入群聊</h2>
            <div id="currentRoomId" class="text-xs text-gray-400"></div>
        </header>

        <!-- Chat History -->
        <main id="chatHistory" class="flex-1 overflow-y-auto p-4 space-y-4 chat-container">
            <div class="flex h-full items-center justify-center text-gray-400 italic">
                从左侧选择一个聊天室开始对话
            </div>
        </main>

        <!-- Options Area -->
        <div id="suggestionArea" class="px-4 py-1 border-t bg-white hidden">
            <div class="flex justify-between items-center mb-1">
                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">回复建议</span>
                <button id="refreshOptions" class="bg-blue-500 text-white px-2 py-0.5 rounded text-xs hover:bg-blue-600 transition-colors">生成建议</button>
            </div>
            <div id="optionsContainer" class="flex flex-wrap gap-2 min-h-[40px]">
                <span class="text-gray-400 text-xs italic">点击“生成建议”按钮获取回复选项</span>
            </div>
        </div>

        <!-- Input Area -->
        <footer id="inputArea" class="p-4 bg-white border-t hidden">
            <div class="max-w-4xl mx-auto">
                <div class="flex gap-2">
                    <textarea id="userInput" 
                        class="flex-1 border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"
                        placeholder="输入消息..." rows="2"></textarea>
                    <button id="sendBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 disabled:bg-gray-400 self-stretch">
                        发送
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <!-- New Room Modal -->
    <div id="newRoomModal" class="modal items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-80 shadow-xl">
            <h3 class="text-lg font-bold mb-4">新建群聊</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">群聊名称</label>
                    <input type="text" id="newRoomName" class="w-full border rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="起个好听的名字">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">群聊ID</label>
                    <input type="text" id="newRoomId" class="w-full border rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="唯一的ID">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal('newRoomModal')" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md">取消</button>
                <button id="confirmNewRoom" class="px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600">创建</button>
            </div>
        </div>
    </div>

    <!-- Join Room Modal -->
    <div id="joinRoomModal" class="modal items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-80 shadow-xl">
            <h3 class="text-lg font-bold mb-4">加入群聊</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">群聊ID</label>
                    <input type="text" id="joinRoomId" class="w-full border rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入群聊ID">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal('joinRoomModal')" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md">取消</button>
                <button id="confirmJoinRoom" class="px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600">加入</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-96 shadow-xl">
            <h3 class="text-lg font-bold mb-4">分享 GalChat</h3>
            <div class="bg-gray-50 p-4 rounded-md border text-sm text-gray-600 mb-4 whitespace-pre-wrap" id="shareTextContent">
                正在获取分享内容...
            </div>
            <div id="copySuccessHint" class="text-green-500 text-xs mb-4 hidden font-medium">✓ 复制成功！</div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('shareModal')" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md">取消</button>
                <button id="confirmCopy" class="px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600">复制文本</button>
            </div>
        </div>
    </div>

    <script>
        const chatHistory = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const optionsContainer = document.getElementById('optionsContainer');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const refreshOptionsBtn = document.getElementById('refreshOptions');
        const roomList = document.getElementById('roomList');
        const currentRoomNameEl = document.getElementById('currentRoomName');
        const currentRoomIdEl = document.getElementById('currentRoomId');
        const inputArea = document.getElementById('inputArea');
        const suggestionArea = document.getElementById('suggestionArea');

        let socket = null;
        let myIP = null;
        let lastSender = null;
        let currentRoomId = null;
        let joinedRooms = JSON.parse(localStorage.getItem('joinedRooms') || '{}');
        let hasGeneratedInCurrentRoom = false;

        function saveJoinedRooms() {
            localStorage.setItem('joinedRooms', JSON.stringify(joinedRooms));
        }

        function renderRoomList() {
            roomList.innerHTML = '';
            Object.entries(joinedRooms).forEach(([id, name]) => {
                const div = document.createElement('div');
                div.className = `room-item p-4 border-b flex justify-between items-center group ${currentRoomId === id ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="flex-1 min-w-0 pr-2">
                        <div class="font-medium text-gray-800 truncate">${name}</div>
                        <div class="text-xs text-gray-400">ID: ${id}</div>
                    </div>
                    <button class="delete-room-btn p-1 rounded-full hover:bg-red-100 opacity-0 group-hover:opacity-100 transition-opacity" title="删除并退出群聊">
                        <img src="/res/delete_group.ico" class="w-4 h-4" alt="delete">
                    </button>
                `;
                
                div.onclick = (e) => {
                    // 如果点击的是删除按钮或其子元素，不执行切换房间
                    if (e.target.closest('.delete-room-btn')) return;
                    switchRoom(id);
                };

                const deleteBtn = div.querySelector('.delete-room-btn');
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    confirmLeaveRoom(id, name);
                };

                roomList.appendChild(div);
            });
        }

        async function confirmLeaveRoom(id, name) {
            if (!confirm(`确定要退出并删除群聊 "${name}" 吗？\n如果该群聊没有其他用户，其所有消息将被永久删除。`)) {
                return;
            }

            try {
                const res = await fetch('/api/rooms/leave', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room_id: id })
                });

                if (res.ok) {
                    delete joinedRooms[id];
                    saveJoinedRooms();
                    
                    if (currentRoomId === id) {
                        currentRoomId = null;
                        if (socket) socket.close();
                        socket = null;
                        chatHistory.innerHTML = '<div class="flex h-full items-center justify-center text-gray-400 italic">从左侧选择一个聊天室开始对话</div>';
                        currentRoomNameEl.innerText = '请选择或加入群聊';
                        currentRoomIdEl.innerText = '';
                        inputArea.classList.add('hidden');
                        suggestionArea.classList.add('hidden');
                    }
                    
                    renderRoomList();
                } else {
                    const data = await res.json();
                    alert(data.detail || '退出失败');
                }
            } catch (err) {
                alert('网络错误');
            }
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        document.getElementById('newRoomBtn').onclick = () => openModal('newRoomModal');
        document.getElementById('joinRoomBtn').onclick = () => openModal('joinRoomModal');
        document.getElementById('shareBtn').onclick = async () => {
            document.getElementById('copySuccessHint').classList.add('hidden');
            openModal('shareModal');
            try {
                const res = await fetch('/api/config/share');
                const data = await res.json();
                document.getElementById('shareTextContent').innerText = data.share_text || '未配置分享文本';
            } catch (err) {
                document.getElementById('shareTextContent').innerText = '获取分享内容失败';
            }
        };

        document.getElementById('confirmCopy').onclick = () => {
            const text = document.getElementById('shareTextContent').innerText;
            if (text === '正在获取分享内容...' || text === '获取分享内容失败' || text === '未配置分享文本') return;
            
            navigator.clipboard.writeText(text).then(() => {
                document.getElementById('copySuccessHint').classList.remove('hidden');
            }).catch(err => {
                alert('复制失败，请手动选择复制');
            });
        };

        document.getElementById('confirmNewRoom').onclick = async () => {
            const name = document.getElementById('newRoomName').value.trim();
            const id = document.getElementById('newRoomId').value.trim();
            if (!name || !id) return alert('请完整填写信息');

            try {
                const res = await fetch('/api/rooms/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room_id: id, name: name })
                });
                if (res.ok) {
                    joinedRooms[id] = name;
                    saveJoinedRooms();
                    renderRoomList();
                    closeModal('newRoomModal');
                    switchRoom(id);
                    document.getElementById('newRoomName').value = '';
                    document.getElementById('newRoomId').value = '';
                } else {
                    const data = await res.json();
                    alert(data.detail || '创建失败');
                }
            } catch (err) {
                alert('网络错误');
            }
        };

        document.getElementById('confirmJoinRoom').onclick = async () => {
            const id = document.getElementById('joinRoomId').value.trim();
            if (!id) return alert('请输入ID');

            try {
                const res = await fetch(`/api/rooms/check/${id}`);
                if (res.ok) {
                    const data = await res.json();
                    joinedRooms[id] = data.name;
                    saveJoinedRooms();
                    renderRoomList();
                    closeModal('joinRoomModal');
                    switchRoom(id);
                    document.getElementById('joinRoomId').value = '';
                } else {
                    const data = await res.json();
                    alert(data.detail || 'ID不存在');
                }
            } catch (err) {
                alert('网络错误');
            }
        };

        function switchRoom(id) {
            if (currentRoomId === id) return;
            currentRoomId = id;
            hasGeneratedInCurrentRoom = false;
            refreshOptionsBtn.innerText = '生成建议';
            
            // UI 更新
            currentRoomNameEl.innerText = joinedRooms[id];
            currentRoomIdEl.innerText = `ID: ${id}`;
            chatHistory.innerHTML = '<div class="flex h-full items-center justify-center text-gray-400 italic">正在连接群聊...</div>';
            inputArea.classList.remove('hidden');
            suggestionArea.classList.remove('hidden');
            renderRoomList();
            
            // WebSocket 切换
            if (socket) {
                socket.close();
            }
            connect(id);
        }

        function updateGenerateBtnState() {
            if (!lastSender) {
                refreshOptionsBtn.disabled = true;
                refreshOptionsBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                refreshOptionsBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                refreshOptionsBtn.title = "聊天记录为空，无法生成建议";
            } else {
                refreshOptionsBtn.disabled = false;
                refreshOptionsBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                refreshOptionsBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                refreshOptionsBtn.title = "";
            }
        }

        function connect(roomId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/ws/chat/${roomId}`);

            socket.onopen = () => {
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
                statusDot.title = '已连接';
                statusText.innerText = '已连接';
                chatHistory.innerHTML = '';
                lastSender = null;
                updateGenerateBtnState();
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'init') {
                    myIP = data.your_ip;
                    updateGenerateBtnState();
                    return;
                }
                
                if (data.type === 'message') {
                    addMessage(data.text, data.user, data.user === myIP);
                }

                if (data.type === 'error') {
                    chatHistory.innerHTML = `<div class="text-red-500 p-4 text-center">${data.message}</div>`;
                }
            };

            socket.onclose = () => {
                statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
                statusDot.title = '连接已断开';
                statusText.innerText = '未连接';
            };

            socket.onerror = (err) => {
                console.error('WebSocket error:', err);
            };
        }

        function addMessage(text, user, isMe) {
            lastSender = user;
            updateGenerateBtnState();

            const div = document.createElement('div');
            div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'text-xs text-gray-500 mb-1 px-1';
            nameSpan.innerText = user;
            
            const bubble = document.createElement('div');
            bubble.className = `${isMe ? 'user-message' : 'other-message'} message-bubble p-3 shadow-sm text-sm`;
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            
            div.appendChild(nameSpan);
            div.appendChild(bubble);
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function fetchOptions() {
            optionsContainer.innerHTML = '<span class="text-gray-400 text-xs italic">正在基于当前对话生成建议...</span>';
            
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        mode: 0,
                        room_id: currentRoomId,
                        current_user: myIP
                    })
                });
                
                const result = await response.json();
                optionsContainer.innerHTML = '';
                
                if (result.status === 'success' && result.data.contents && result.data.contents.length > 0) {
                    hasGeneratedInCurrentRoom = true;
                    refreshOptionsBtn.innerText = '刷新建议';
                    result.data.contents.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded-full text-xs hover:bg-blue-50 shadow-sm flex items-center gap-1';
                        
                        const contentSpan = document.createElement('span');
                        contentSpan.innerText = opt.content;
                        btn.appendChild(contentSpan);

                        if (opt.emotion) {
                            const emotionTag = document.createElement('span');
                            emotionTag.className = 'bg-blue-100 text-blue-500 px-1.5 py-0.5 rounded text-[10px] font-bold';
                            emotionTag.innerText = opt.emotion;
                            btn.appendChild(emotionTag);
                        }

                        btn.onclick = () => {
                            userInput.value = opt.content;
                            userInput.focus();
                        };
                        optionsContainer.appendChild(btn);
                    });
                } else {
                    optionsContainer.innerHTML = '<span class="text-gray-400 text-xs italic">暂无建议，点击“生成建议”重试</span>';
                }
            } catch (err) {
                console.error(err);
                optionsContainer.innerHTML = '<span class="text-red-400 text-xs italic">获取建议失败</span>';
            }
        }

        function sendMessage(text) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    text: text
                }));
                return true;
            }
            return false;
        }

        sendBtn.onclick = () => {
            const text = userInput.value.trim();
            if (!text) return;
            
            if (sendMessage(text)) {
                userInput.value = '';
            } else {
                alert('未连接到服务器');
            }
        };

        refreshOptionsBtn.onclick = fetchOptions;

        userInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
                if (e.ctrlKey) {
                    e.preventDefault();
                    sendBtn.click();
                } else if (!e.shiftKey) {
                    e.preventDefault();
                    sendBtn.click();
                }
            }
        };

        // 初始渲染列表
        renderRoomList();
    </script>
</body>
</html>
